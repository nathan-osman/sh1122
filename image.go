package sh1122

import (
	"image/color"
)

// Image data sent to the display is 4-bit

var palette = []color.Color{
	color.RGBA{0x00, 0x00, 0x00, 0xff},
	color.RGBA{0x11, 0x11, 0x11, 0xff},
	color.RGBA{0x22, 0x22, 0x22, 0xff},
	color.RGBA{0x33, 0x33, 0x33, 0xff},
	color.RGBA{0x44, 0x44, 0x44, 0xff},
	color.RGBA{0x55, 0x55, 0x55, 0xff},
	color.RGBA{0x66, 0x66, 0x66, 0xff},
	color.RGBA{0x77, 0x77, 0x77, 0xff},
	color.RGBA{0x88, 0x88, 0x88, 0xff},
	color.RGBA{0x99, 0x99, 0x99, 0xff},
	color.RGBA{0xaa, 0xaa, 0xaa, 0xff},
	color.RGBA{0xbb, 0xbb, 0xbb, 0xff},
	color.RGBA{0xcc, 0xcc, 0xcc, 0xff},
	color.RGBA{0xdd, 0xdd, 0xdd, 0xff},
	color.RGBA{0xee, 0xee, 0xee, 0xff},
	color.RGBA{0xff, 0xff, 0xff, 0xff},
}

// Flip blits the content of the internal buffer to the display. This is done
// using two SPI transfers since the SPI buffer is usually limited to 4096.
func (s *SH1122) Flip() error {
	b := make([]byte, (Width*Height)/2)
	for y := 0; y < Height; y++ {
		for x := 0; x < Width; x += 2 {
			p1 := s.img.ColorIndexAt(x, y)
			p2 := s.img.ColorIndexAt(x+1, y)
			b[(y*Width+x)/2] = (p1 << 4) | p2
		}
	}
	if err := s.send(b, false); err != nil {
		return s.send(b[:4096], false)
	}
	return s.send(b[4096:], false)
}
